<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gocle.yangju.forest.adm.board.service.impl.AdminBoardMapper">

	<select id="listBoardConfig" resultType="BoardConfigVO" parameterType="BoardConfigVO">
		<include refid="kr.co.gocle.include.paging-start" />
		SELECT
			CB.BC_ID
			,CB.BC_NAME
			,CB.BC_USE
			,CB.BC_TYPE
			,CB.BC_SUPPORT_THUMBNAIL
			,CB.BC_THUMBNAIL_CROP
			,BC_THUMBNAIL_WIDTH
			,CB.BC_THUMBNAIL_HEIGHT
			,CB.BC_UPLOAD_FILE_NUM
			,CB.BC_UPLOAD_SIZE_MAX
			,CB.BC_REGDATE
			,CB.BC_CATEGORY1
			,CB.REG_DT
		FROM COM_BOARD_CONFIG CB
		WHERE CB.DELETE_YN= 'N'
		<choose>
			<when test="searchCondition != null and searchCondition != ''">
				<if test="searchCondition eq 'BC_NAME'">
					<if test="searchKeyword != null and searchKeyword != ''">
						AND CB.BC_NAME LIKE '%' || #{searchKeyword } || '%'
					</if>
				</if>
				<if test="searchCondition eq 'BC_ID'">
					<if test="searchKeyword != null and searchKeyword != ''">
						AND CB.BC_ID LIKE '%' || #{searchKeyword } || '%'
					</if>
				</if>
			</when>
			<otherwise>
				<if test="searchKeyword != null and searchKeyword != ''">
					AND ( CB.BC_NAME LIKE '%' || #{searchKeyword } || '%' OR CB.BC_ID LIKE '%'
					|| #{searchKeyword } || '%' )
				</if>
			</otherwise>	
		</choose>
		<include refid="kr.co.gocle.include.paging-end" />
	</select>
	
	<insert id="insertBoardConfig" parameterType="BoardConfigVO">
		INSERT
		INTO COM_BOARD_CONFIG
		(
		BC_ID
		,BC_NAME
		,BC_USE
		,BC_TYPE
		,BC_SUPPORT_NOTICE
		,BC_NOTICE_EVERY_PAGE
		,BC_SUPPORT_SECRET
		,BC_SUPPORT_COMMENT
		,BC_SUPPORT_ANSWER
		,BC_SUPPORT_RECOMMEND
		,BC_SUPPORT_THUMBNAIL
		,BC_THUMBNAIL_CROP
		,BC_THUMBNAIL_WIDTH
		,BC_THUMBNAIL_HEIGHT
		,BC_UPLOAD_FILE_NUM
		,BC_UPLOAD_SIZE_MAX
		,BC_PAGE_SIZE
		,BC_REGDATE
		,BC_SUPPORT_IMAGE
		,REG_DT
		,REG_ID
		)
		VALUES
		(
		#{bcId}
		,#{bcName}
		,#{bcUse}
		,#{bcType}
		,#{bcSupportNotice}
		,#{bcNoticeEverypage}
		,#{bcSupportSecret}
		,#{bcSupportComment}
		,#{bcSupportAnswer}
		,#{bcSupportRecommend}
		,#{bcSupportThumbnail}
		,#{bcThumbnailCrop}
		,#{bcThumbnailWidth}
		,#{bcThumbnailHeight}
		,#{bcUploadFileNum}
		,#{bcUploadSizeMax}
		,#{bcPageSize}
		, NOW()
		,#{bcSupportImage}
		, NOW()
		,#{sessionMemSeq}
		)
	</insert>
	
	<select id="selectBoardConfig" parameterType="BoardConfigVO" resultType="BoardConfigVO">
		SELECT *
		FROM COM_BOARD_CONFIG
		WHERE BC_ID = #{bcId}
	</select>
	
	<update id="updateBoardConfig" parameterType="BoardConfigVO">
		UPDATE COM_BOARD_CONFIG
		SET BC_NAME = #{bcName}
			,BC_USE = #{bcUse}
			,BC_TYPE = #{bcType}
			,BC_SUPPORT_NOTICE = #{bcSupportNotice}
			,BC_NOTICE_EVERY_PAGE = #{bcNoticeEverypage}
			,BC_SUPPORT_SECRET = #{bcSupportSecret}
			,BC_SUPPORT_COMMENT = #{bcSupportComment}
			,BC_SUPPORT_ANSWER = #{bcSupportAnswer}
			,BC_SUPPORT_RECOMMEND = #{bcSupportRecommend}
			,BC_SUPPORT_THUMBNAIL = #{bcSupportThumbnail}
			,BC_THUMBNAIL_CROP = #{bcThumbnailCrop}
			,BC_THUMBNAIL_WIDTH = #{bcThumbnailWidth}
			,BC_THUMBNAIL_HEIGHT = #{bcThumbnailHeight}
			,BC_UPLOAD_FILE_NUM = #{bcUploadFileNum}
			,BC_UPLOAD_SIZE_MAX = #{bcUploadSizeMax}
			,BC_PAGE_SIZE = #{bcPageSize}
			,BC_SUPPORT_IMAGE =#{bcSupportImage}
			,UPD_DT = NOW()
		 	,UPD_ID = #{sessionMemSeq}
		WHERE BC_ID = #{bcId}
	</update>
	
	<update id="deleteBoardConfig" parameterType="BoardConfigVO">
		UPDATE COM_BOARD_CONFIG
		SET DELETE_YN = 'Y'
		,UPD_DT = NOW()
		,UPD_ID = #{sessionMemSeq}
		WHERE BC_ID = #{bcId}
	</update>
	
	<select id="listBoardArticle" resultType="BoardArticleVO" parameterType="BoardArticleVO">
		<include refid="kr.co.gocle.include.paging-start" />
	    SELECT
	        CA.BA_ID,
	        CC.BC_ID,
	        CA.BA_TITLE,
	        CA.MEM_ID,
	        CA.BA_CONTENT_HTML,
	        CA.BA_CONTENT_PLAIN,
	        DATE_FORMAT(CA.BA_REGDATE, '%Y.%m.%d') AS BA_REGDATE,
	        (
	            SELECT AF.SAVE_FILE_NAME
	            FROM ATCH_FILE AF
	            WHERE AF.THUMBNAIL_CROP = 'Y'
	              AND AF.DELETE_YN = 'N'
	              AND CA.BA_ID = AF.BOARD_IDX
	            LIMIT 1
	        ) AS BA_THUMBPATH,
	        IFNULL(CM.MEM_NAME, CA.BA_GUEST_NAME) AS MEM_NAME,
	        CA.BA_HIT,
	        CA.BA_SECRET,
	        CA.REG_ID,
	        CA.REG_DT,
	        CA.BA_CATEGORY1,
	        CA.BA_NOTICE,
	        FN_GET_CODE_NAME('BOARD_DATA', CA.BA_CATEGORY1) AS BOARD_DATA_CATEGORY1,
	        FN_GET_CODE_NAME('PROCESS_STATUS_ARTICLE', CA.PROCESS_STATUS_ARTICLE) AS PROCESS_STATUS_ARTICLE
	    FROM COM_BOARD_ARTICLE CA
	    INNER JOIN COM_BOARD_CONFIG CC ON CC.BC_ID = CA.BC_ID
	    LEFT JOIN COM_MEMBER CM ON CM.MEM_SEQ = CA.REG_ID
	    WHERE CA.DELETE_YN = 'N'
	      AND CA.BC_ID = #{bcId}
	      AND CA.BA_NOTICE = #{baNotice}
	
	    <if test="searchCondition != null and searchCondition != ''">
	        <if test="searchKeyword != null and searchKeyword != ''">
	        	<choose>
			   		<when test="searchCondition == 'BA_CONTENT_HTML'">
			   			<![CDATA[ AND REGEXP_REPLACE(CA.BA_CONTENT_HTML, '<[^>]*>', '') LIKE CONCAT('%', #{searchKeyword}, '%') ]]>
			    	</when>
				    <otherwise>
				      	AND CA.${searchCondition} LIKE CONCAT('%', #{searchKeyword}, '%')
				    </otherwise>
			  </choose>
	        </if>
	    </if>
	    
		<if test="searchCondition == null or searchCondition == ''">
		    <if test="searchKeyword != null and searchKeyword != ''">
		        AND (
		            CA.BA_TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
		            <![CDATA[ OR REGEXP_REPLACE(CA.BA_CONTENT_HTML, '<[^>]*>', '') LIKE CONCAT('%', #{searchKeyword}, '%') ]]>
		        )
		    </if>
	    </if>
	
	    <if test="baCategory1 != null and baCategory1 != ''">
	        AND CA.BA_CATEGORY1 = #{baCategory1}
	    </if>
	    ORDER BY CA.BA_REGDATE DESC
	    <include refid="kr.co.gocle.include.paging-end" />
    </select>
    
    <select id="topNoticeList" parameterType="BoardArticleVO" resultType="BoardArticleVO">
    	SELECT A.*
		FROM (
		    SELECT
		        CA.BA_ID,
		        CC.BC_ID,
		        CA.BA_TITLE,
		        CA.MEM_ID,
		        CA.BA_CONTENT_HTML,
		        DATE_FORMAT(CA.BA_REGDATE, '%Y.%m.%d') AS BA_REGDATE,
		        (
		            SELECT AF.SAVE_FILE_NAME
		            FROM ATCH_FILE AF
		            WHERE AF.THUMBNAIL_CROP = 'Y'
		              AND AF.DELETE_YN = 'N'
		              AND CA.BA_ID = AF.BOARD_IDX
		            LIMIT 1
		        ) AS BA_THUMBPATH,
		        CM.MEM_NAME,
		        CA.BA_HIT,
		        CA.BA_SECRET,
		        CA.REG_ID,
		        CA.REG_DT,
		        CA.BA_CATEGORY1,
		        CA.BA_NOTICE,
		        CA.DELETE_YN,
		        FN_GET_CODE_NAME('BOARD_DATA', CA.BA_CATEGORY1) AS BOARD_DATA_CATEGORY1
		    FROM COM_BOARD_ARTICLE CA
		    INNER JOIN COM_BOARD_CONFIG CC ON CC.BC_ID = CA.BC_ID
		    LEFT JOIN COM_MEMBER CM ON CM.MEM_SEQ = CA.REG_ID
		    WHERE CA.DELETE_YN = 'N'
		      AND CA.BA_NOTICE = 1
		      AND CA.BC_ID = #{bcId}
		      
		    <if test="searchCondition != null and searchCondition != ''">
		        <if test="searchKeyword != null and searchKeyword != ''">
		        	<choose>
				   		<when test="searchCondition == 'BA_CONTENT_HTML'">
				   			<![CDATA[ AND REGEXP_REPLACE(CA.BA_CONTENT_HTML, '<[^>]*>', '') LIKE CONCAT('%', #{searchKeyword}, '%') ]]>
				    	</when>
					    <otherwise>
					      	AND CA.${searchCondition} LIKE CONCAT('%', #{searchKeyword}, '%')
					    </otherwise>
				  </choose>
		        </if>
		    </if>
			
			<if test="searchCondition == null or searchCondition == ''">
			    <if test="searchKeyword != null and searchKeyword != ''">
			        AND (
			            CA.BA_TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
			            <![CDATA[ OR REGEXP_REPLACE(CA.BA_CONTENT_HTML, '<[^>]*>', '') LIKE CONCAT('%', #{searchKeyword}, '%') ]]>
			        )
			    </if>
		    </if>
		    ORDER BY CA.BA_REGDATE DESC
		    LIMIT 3
		) A
		ORDER BY A.BA_REGDATE DESC;
    </select>
    
    <insert id="insertBoardArticle" parameterType="BoardArticleVO">
		INSERT INTO COM_BOARD_ARTICLE
		(
			BA_ID
			,BC_ID
			,BA_TITLE
			,BA_CONTENT_HTML
			<if test="baContentPlain != null and baContentPlain != ''">,BA_CONTENT_PLAIN</if>
			,BA_THUMB
			,BA_CATEGORY1
			,BA_NOTICE
			,BA_REGDATE
			,REG_DT
			,REG_ID
		)
		VALUES
		(
			#{baId}
			,#{bcId}
			,#{baTitle}
			,#{baContentHtml}
			<if test="baContentPlain != null and baContentPlain != ''">,#{baContentPlain}</if>
			,#{baThumb}
			,#{baCategory1}
			,#{baNotice}
			,NOW()
			,NOW()
			,#{sessionMemSeq}
		)
	</insert>
	
	<select id="selectBoardArticle" resultType="BoardArticleVO" parameterType="BoardArticleVO">
		SELECT
		    CA.BC_ID,
		    CA.BA_ID,
		    CA.BA_TITLE,
		    CA.BA_CONTENT_HTML,
		    CA.BA_CONTENT_PLAIN,
		    CA.BA_HIT,
		    CA.BA_RECOMMEND,
		    DATE_FORMAT(CA.BA_REGDATE, '%Y-%m-%d') AS BA_REGDATE,
		    IFNULL(CM.MEM_NAME, CA.BA_GUEST_NAME) AS MEM_NAME,
		    CA.BA_NOTICE,
		    CA.BA_GUEST_PASSWORD,
		    (
		        SELECT AF.SAVE_FILE_NAME
		        FROM ATCH_FILE AF
		        WHERE AF.THUMBNAIL_CROP = 'Y'
		          AND AF.DELETE_YN = 'N'
		          AND CA.BA_ID = AF.BOARD_IDX
		        LIMIT 1
		    ) AS BA_THUMBPATH,
		    CA.BA_SECRET,
		    CA.BA_CATEGORY1,
		    CA.BA_NOTICE,
		    CA.PROCESS_STATUS_ARTICLE,
		    CA.REG_ID,
		    CA.REG_DT
		FROM COM_BOARD_ARTICLE CA
		LEFT JOIN COM_MEMBER CM
		    ON CM.MEM_SEQ = CA.REG_ID
		WHERE CA.BC_ID = #{bcId}
		  AND CA.BA_ID = #{baId}
	</select>
	
	<select id="listBoardReply" resultType="BoardReplyVO" parameterType="BoardReplyVO">
		SELECT
			CB.BR_ID,
			CB.BA_ID,
			CB.BR_CONTENT,
			CB.ATCH_FILE_IDX,
			CB.REG_DT,
			CB.REG_ID,
			CB.UPD_DT,
			CB.UPD_ID,
			AF.ORG_FILE_NAME,
			AF.DELETE_YN AS rDeleteYn,
			CM.MEM_NAME
	    FROM COM_BOARD_REPLY CB
			LEFT OUTER JOIN ATCH_FILE AF
			ON CB.ATCH_FILE_IDX = AF.ATCH_FILE_IDX
			LEFT JOIN COM_MEMBER CM
		    ON CM.MEM_SEQ = CB.REG_ID
		WHERE CB.BA_ID = #{baId} 
		AND CB.DELETE_YN = 'N'
		ORDER BY REG_DT DESC
	</select>
	
	<update id="updateArticleBoard" parameterType="BoardArticleVO">
		UPDATE COM_BOARD_ARTICLE
		SET BA_TITLE = #{baTitle}
			,BA_CONTENT_HTML = #{baContentHtml}
			<if test="baContentPlain != null and baContentPlain != ''">,BA_CONTENT_PLAIN = #{baContentPlain}</if>
			,PROCESS_STATUS_ARTICLE = #{processStatusArticle}
			,BA_LAST_MODIFIED = NOW()
			,UPD_DT = NOW()
		 	,UPD_ID = #{sessionMemSeq}
		 	,BA_CATEGORY1 = #{baCategory1}
		 	,BA_NOTICE = #{baNotice}
		WHERE BA_ID = #{baId} AND BC_ID = #{bcId}
	</update>
	
	<update id="deleteBoardArticle" parameterType="BoardArticleVO">
		UPDATE COM_BOARD_ARTICLE
		SET DELETE_YN= 'Y',
			BA_LAST_MODIFIED = NOW()
		WHERE BC_ID = #{bcId} AND BA_ID = #{baId} 
	</update>
	
	<select id="getBoardArticle" resultType="BoardArticleVO"
		parameterType="BoardArticleVO">

		SELECT
			CA.BC_ID,
			CA.BA_ID,
			CA.BA_TITLE,
			CA.BA_CONTENT_HTML,
			CA.BA_CONTENT_PLAIN,
			CA.BA_HIT,
			CA.BA_RECOMMEND,
			DATE_FORMAT(CA.BA_REGDATE, '%Y-%m-%d') AS BA_REGDATE,
			IFNULL(CM.MEM_NAME,CA.BA_GUEST_NAME) AS MEM_NAME,
			CA.PROCESS_STATUS_ARTICLE,
			CA.BA_NOTICE,
			CA.BA_GUEST_PASSWORD,
			(SELECT AF.SAVE_FILE_NAME
				FROM ATCH_FILE AF
				WHERE AF.THUMBNAIL_CROP = 'Y' AND  AF.DELETE_YN = 'N'
				AND CA.BA_ID = AF.BOARD_IDX) AS BA_THUMBPATH,
			CA.BA_SECRET,
			FN_GET_CODE_NAME('PROCESS_STATUS_ARTICLE',CA.PROCESS_STATUS_ARTICLE) as PROCESS_STATUS,
			CA.BA_CATEGORY1,
			CA.BA_NOTICE
		FROM COM_BOARD_ARTICLE CA
		LEFT JOIN COM_MEMBER CM
        ON CM.MEM_SEQ = CA.REG_ID
		WHERE CA.BC_ID = #{bcId} 
		AND CA.BA_ID = #{baId}

	</select>
	
	
	<insert id="insertBoardReply" parameterType="BoardReplyVO">

		INSERT INTO COM_BOARD_REPLY
		(
			BR_ID,
			BA_ID,
			BR_CONTENT,
			ATCH_FILE_IDX,
			REG_DT,
			REG_ID
		)
		VALUES
		(
			#{brId}
			,#{baId}
			,#{brContent}
			,#{atchFileIdx}
			,NOW()
			,#{sessionMemSeq}
		)

	</insert>
	
	<update id="deleteBoardReply" parameterType="BoardReplyVO">
		update COM_BOARD_REPLY
		set DELETE_YN = 'Y' ,
			UPD_ID = #{sessionMemSeq},
			UPD_DT = NOW()
		WHERE BR_ID = #{brId} 
		and BA_ID = #{baId}
	</update>
	
	<update id="updateBoardReply" parameterType="BoardReplyVO">
		update COM_BOARD_REPLY
		set BR_CONTENT = #{brContent},
			ATCH_FILE_IDX = #{atchFileIdx},
			UPD_ID = #{sessionMemSeq},
			UPD_DT = NOW()
		WHERE BR_ID = #{brId}
		 and BA_ID = #{baId}
	</update>
	
	<select id="getBoardConfig" parameterType="BoardConfigVO"
		resultType="BoardConfigVO">

		SELECT *
		FROM COM_BOARD_CONFIG
		WHERE BC_ID = #{bcId}

	</select>
	
	<select id="selectBoardReply" parameterType="BoardReplyVO" resultType="BoardReplyVO">
		SELECT CB.BR_ID
			 , CB.BA_ID
			 , CB.BR_CONTENT
			 , CB.ATCH_FILE_IDX
			 , CB.REG_ID
			 , IFNULL(AF.DELETE_YN, 'N') AS rDeleteYn
		FROM COM_BOARD_REPLY CB
		LEFT OUTER JOIN ATCH_FILE AF
			ON CB.ATCH_FILE_IDX = AF.ATCH_FILE_IDX
		WHERE CB.BR_ID = #{brId}
		AND CB.BA_ID = #{baId}
		AND CB.DELETE_YN = 'N'
	</select>
</mapper>